#############################################################
## NAMD: Constant Force SMD Unfolding of DNA in GBIS 	   ##
#############################################################

## USAGE
# Search for TODO
# Change "if {0}" to "if {1}" and vice-versa to enable/disable a section.

## ------------------------------------------------------------------------------
# Constant Force SMD Unfolding of DNA Hairpin (1D16) in GBIS:
# FORCE 22 pN (.32) | Dummy Eq dist 2 A, k 10 kcal/mol/A2 | CUTOFF 16 A | BORN 14 A SASA ON (0.005) | ION CONC 0.2 M | 2 fs/step | C1:C5'-DUM CONSTRAINTED
## ------------------------------------------------------------------------------

# TODO: 0 -> first run, increment for successive restarts. 
# for restarts, output file names are appended by the run_index 
# ex. for 1st restart (run_index 1) -> output1.dcd, output1.coor
set run_index		0;

# TODO (IF RESTARTING): last step of previous run (from log file)
firsttimestep		0;
#############################################################
## ADJUSTABLE PARAMETERS                                   ##
#############################################################

structure          dna_dummy.psf;		# TODO: input structure info (.psf) file
coordinates        dna_gbis_eq.pdb;		# TODO: input initial coordinates (.pdb) file

# defining variables used at multiple places
set temperature          300;
set outputnameprefix     dna_gbis_pcf;				# TODO: output name	

# output name for this run
if {$run_index > 0} {
	set outputname           $outputnameprefix$run_index; # for restarts, append run_index on the file name
} else {
	set outputname           $outputnameprefix;	
}

# continuing a run
if {$run_index > 0} {
	# restart file name prefix from last run
	if {$run_index == 1} {
		# First restart -> just prefix
		set restartfilename		$outputnameprefix.restart;	   
	} else { 
		# 2nd, 3rd etc restarts
		set restartfilename		$outputnameprefix[expr $run_index - 1].restart;
	}
	
	binCoordinates        $restartfilename.coor;	# binary coordinates from last run restart.coor file
	binVelocities         $restartfilename.vel;	# binary velocities from last run restart.vel file
	extendedSystem        $restartfilename.xsc;	# cell dimensions from last run restart.xsc file (only for variable V simulations)
	
	#numsteps        100000;		# (redundant) run stops when this step is reached
} else {
	# Initialize velocities from Equilibriation Run
	binVelocities 		dna_gbis_eq.restart.vel;
	extendedSystem		dna_gbis_eq.restart.xsc;
}


#############################################################
## SIMULATION PARAMETERS                                   ##
#############################################################

# Input
paraTypeCharmm	    on;
parameters		par_all36_na_dummy.prm;
#parameters		../common/par_all36_prot.prm;
#parameters		../common/par_all36_carb.prm;
#parameters		../common/par_all36_cgenff.prm;
#parameters		../common/par_all36_lipid.prm;
#parameters		../common/par_all36_lipid_ljpme.prm;
#parameters		../common/par_all36m_prot.prm;

# Topology and Parameter (toppar) Stream (.str) files: provides additional force filed parameters
parameters		../common/toppar_water_ions_namd.no_co_nbfix.str;	# for water and ions
#parameters		../common/toppar_all36_carb_glycopeptide.str


# NOTE: Do NOT set the initial temperature if you have also specified a .vel restart file. 
# The Temperature will be calculated from restart.vel file
if {$run_index == 0 && 0} {
	temperature         $temperature;	# the initial temperature
}

## Force-Field Parameters
exclude             scaled1-4;  # which DIRECTLY-BONDED atom pairs are excluded from non-bonding interactions. "scaled1-4" means neglect non-bonding interactions of 1-2 and 1-3, and scale for 1-4 acc to "1-4scaling" option
1-4scaling          1.0;	# how much the Electrostatic interation b/w 1-4 atoms (3 bonds apart) is "turned ON" ....in range [0, 1]

cutoff              16.0;	# distance (in Å) after which Electrostatic and VanderWall Interactions are cut-off. 
							# However, for fast elec solvers PME and MSM, cutoff acts as a splitting distance b/w short and long range interactions
switching           on;		# use switching functions to smoothly bring VdW and Electrostatic interactions to 0 at cutoff distance (and not abruptly set it to 0)
switchdist          14.0;		# distance (in Å) to start the smooth decay of VdW and Elec interaction energy. (should be < cutoff)

pairlistdist        18.0;	# distance (in Å) up-till which to list atoms (for each atom) for possible VdW and Elec interactions (should be > cutoff)


## Integrator Parameters
timestep            2.0;	# delta t, in femtoseconds (fs)
rigidBonds          all;	# whether linear bonds involving H are maintained rigid (fixed bond-length). Values: none | water | all
							# (needed for steps >= 2fs) (water should ALWAYS be rigid since it is paramaterized that way)
							
nonbondedFreq       1;		# how often (in no of timesteps) should NON-BONDED interactions be calculated
fullElectFrequency  1;		# how often (in no of timesteps) should ELECTROSTATIC interactions be calculated
stepspercycle       2;		# no of timesteps in one CYCLE. Atoms are reassigned pair-lists after each cycle within pairlistdist for possible VdW and Elec interactions


### Generalized Bron Implicit Solvent: implicit model for Water AND Ions
# Note: With GBIS
#		1. Structure and Coordinates should NOT contain any water or ion molecules
#		2. No periodic boundary condition
#		3. No Constant P control
#		4. No PME (i.e no long range electrostatics)
#		5. Cut off should be higher than that with PME to account long-rong electrostatics
if {1} {
	gbis                on;
	alphaCutoff         14.0;		# (Å) Used to calculate Born radius of atoms. Usually a few A smaller than cutoff distance 
	ionConcentration    0.2;		# Concentration of implict ions in moles/L (M). High conc -> high electrostatic screening (low elec interactions b/w actual atoms)
	
	solventDielectric	78.5;		# Dielectric constant of solvent, usually water 78.5 or 80

	if {1} {
		sasa				on;			# calculate Solvent Accessible Surface Area (SASA), and use it to compute non-polar (hydrophobic) energy contribution of system-implict solvent interaction
										# Non-polar (Hydrophobic) interaction Energy = sasa * surface_tension. This is added to ELECTROSTATIC Energy
		surfaceTension		0.005;		# Surface Tension, in kcal/mol/Å**2
	}
}

# Periodic Boundary Conditions (TODO: calaulate for your system)
# NOTE 1: cell origin is the geometric center of unit cell from absolute origin
# cell basis vectors are from bottom-left vertex of the unit cell
# (all dimensions are in Å)
if {0} {
	# NOTE 2: DON'T specify when restart.xsc file is also specified as "extendedSystem" ex. when restarting sim
	# These are then read from restart.xsc file
	if {$run_index == 0} {
		cellBasisVector1 71.10800170898438 0 0 
		cellBasisVector2 0 59.82600021362305 0 
		cellBasisVector3 0 0 68.79299926757813 
		cellOrigin 13.236000061035156 -0.7539997100830078 10.015499114990234
	}

	# wrapWater			on;		# Whether to wrap water atoms
	wrapAll             on;		# Whether to wrap ALL atoms
}

## Constant Temperature Control
# Principle: Total K.E of system = sum(1/2 mv^2) = 3/2N KbT (N: no of atoms)
# NOTE: Atomic velocities are rescaled at each frame to maintain constant T (or K.E)
#       Disable to minimize disturbances in atomic motion ex. when using Constant Vel SMD 
if {1} {
	langevin            on;		# do langevin dynamics
	langevinDamping     1;		# damping coefficient (gamma) (in 1/picoseconds)
	langevinTemp        $temperature;	# temperature to maintain during equilibration (in K)
	langevinHydrogen    off;	# whether to use Langevin dynamics on Hydrogen
}

if {1} {
	rescaleFreq         2
	rescaleTemp         $temperature
}

# Constant Pressure Control (variable volume) - only for PERIODIC systems
if {0} {
	useGroupPressure      yes;	# whether to use the pressure of a group of H atoms rather than individual H's. needed for rigidBonds
	useFlexibleCell       yes;	# allows cell dimensions to vary independently of each other
	useConstantArea       no;	# whether to maintain constant x-y cross-sectional area, and just vary z-dimension

	langevinPiston        on
	langevinPistonTarget  1.01325;	# target pressure (in bar) that the langevin piston tries to maintain during simulation
	langevinPistonPeriod  100.0;	# oscillation time period (in femtoseconds) of langevin piston
	langevinPistonDecay   50.0;		# damping time constant (in femtoseconds) of langevin piston
	langevinPistonTemp    $temperature;	# must be equal to langevinTemp if constant T control is in use
}

# Particle Mesh Ewald (PME) (for full-system periodic electrostatics)
if {0} {
	PME                 yes;	# Enable PME - Fast solver for long-range electrostatics in periodic systems
	PMEGridSpacing      1.0;	# spacing b/w PME grid points on cell basis vectors (in Å), used for automatic PME grid sizes

	# manual grid definition (must be divisible by 2, 3 or 5 for Fast Fourier Transform)
	#PMEGridSizeX        45;	# no of grid points on cellBasisVector1
	#PMEGridSizeY        45;	# no of grid points on cellBasisVector2
	#PMEGridSizeZ        48;	# no of grid points on cellBasisVector3
}

# Multistep Summation Method (MSM) - mostly used for non-periodic systems
if {0} {
	MSM                 on;		# Enable MSM - Fast solver for long-range electrostatics, mostly used for non-periodic systems
	MSMGridSpacing      2.5;	# spacing b/w MSM grid points (in Å). Very sensitive to performance, use this default
	
	### MSM Grid Size for Non-Periodic simulations
	# NOTE: All atoms must remain confined within this space. For this, restraining potentials such as sphericalBC are generally used
	# Calculate min and max coordinates of all atoms within entire system, and round to next higher integer
	MSMxmin -18.0
	MSMymin -34.0
	MSMzmin -40.0
	MSMxmax 120.0
	MSMymax 68.0
	MSMzmax 68.0
}

# Output
outputName          $outputname

restartfreq         500;	# how often (in no of time steps) the simulation state is saved for easy restart later. saves atomic coordinates and velocities in restart.coord and restart.vel file
dcdfreq             100;		# how often (in no of time steps) the atomic coordinates are saved in trajectory .dcd file
outputEnergies      100;		# how often (in no of time steps) the system Energy is saved in .log file
if {0} {
	outputPressure      100;		# ONLY FOR PERIODIC SIMS: how often (in no of time steps) the system Pressure is saved in .log file
}
if {0} {
	xstfreq             500;	# ONLY FOR VARIABLE VOLUME: how often (in no of time steps) the unit cell dimensions (or vertices) are saved in extended system trajectory .xst file
}

# IMD Settings (can view simultaion live in VMD)
if {0} {
	IMDon           on
	IMDport         3000    ;# port number (enter it in VMD)
	IMDfreq         1       ;# send every 1 frame
	IMDwait         no      ;# wait for VMD to connect before running?
}

#############################################################
## EXTRA PARAMETERS                                        ##
#############################################################
# Put here any custom parameters that are specific to this job (e.g SMD, TclForces, etc...)

# Spherical Boundary Condition (using COM) (in Å)
if {0} {
	sphericalBCcenter   14.7047119140625 -1.2427393198013306 7.503101348876953
	sphericalBCr1       60
}

# Fixed Atoms Constraint (ex in SMD)
if {1} {
	fixedAtoms          on;		# allow some atoms to be spacially fixed
	fixedAtomsCol       B;		# which column is used to specify fixed aToms (one of X, Y, Z, B (beta), O (occupancy)) [defau;t: beta (B)]
	fixedAtomsFile      dna_gbis_eq.smd-pcf.pdb;	# TODO: pdb file containing Fixed atoms (atoms with beta B = 1)
}

## SMD: Steered Molecular Dynamics (only for constant velocity pulling)
# 1. A dummy atom is connected via virtual spring to the COM of SMD atom(s)
# 2. Constant vel pull is then applied to the dummy atom, 
# 3. Force Analysis: force experienced by COM of SMD atom(s) is studied 
#		     vs [time] or vs [SMD COM displacement] or vs [SMD COM-fixed atom distance]   
if {0} {
	SMD			on;		# enable SMD
	SMDFile			dna_gbis_eq.smd-pcv.pdb;		# TODO: pdb file containing SMD atoms (atoms with occupancy O = 1)
	SMDk			7;		# (kcal/mol/Å2) SMD virtual spring constant between COM of SMD atom(s) and dummy atom 
	SMDVel			0.001;	# (A/timestep) constant pull velocity applied to dummy atom
	
	# Unit vector representing the direction of applied pull. 
	# Mostly its just the unit vector connecting fixed and COM of SMD atom(s) = vecnorm [vecsub $smdatompos $fixedatompos]
	SMDDir			0.3976350723925137 0.37333521574953327 0.8381570055094988;
	
	SMDOutputFreq	10;		# timesteps between consecutive smd output to .log file
}

# Constant Force Pulling SMD (note that this does not require "SMD on")
# 1. No dummy atom or virtual spring
# 2. Constant force is directly applied to SMD atom(s) indivially i.e SMD atoms can have different forces
# 3. Distance Analysis: distance b/w COM of SMD atom(s) and fixed atom (end-to-end distnace) vs time
#					 OR SMD atom displacement vs time
if {1} {
	constantforce yes;		# Enable constant force pull on below specified atoms
			
	# pdb containing atoms to which constant force will be applied
	# constant force is ONLY applied to atoms with occupancy O != 0 in the below file
	# 1. occupancy (O) of each atom is treated as the magnitude of Force to be applied 
	#	(in kcal/mol/Å = 69.5 pico N (pN))
	# 2. the x,y,z values of each atom are used to specify direction of force to be applied (and NOT coordinates)
	# 3. Force vector for each atom = (x, y, z) * O  (mag in kcal/mol/Å)
	consforcefile dna_gbis_eq.smd-pcf.pdb;	
}


# ------- Harmonic Constraints ---------
# Used to constraint some atoms about their reference positions. Like a harmonic SPRING, they can osciallte about their reference pos
# -> constraint Energy E_i = k_i (r_i - r_i_ref)^e, where k_i: force constant (kcal/mol/A^2), r_i_ref: equilibium position (A) of i'th atom
# -> Constraint Force F_i = e * k_i (r_i - r_i_ref) ^ (e-1)    on i'th atom
# -> Effective force constant = e * k_i
if {1} {
	constraints			on;			# on | off harmonic constraints
	consexp				2;			# exponent used in harmonic constraints (e). [Default 2] like in Hooks Law. V(x) = 1/2 k x^2
	
	conskfile			dna_gbis_eq.constraints.pdb;		# PDB File with force constants (kcal/mol/A^2) for each atom in a column. Atoms with NON_ZERO value of k are constrained 
	conskcol			O;								# Column specifying force constants in above file. Can be X, Y, Z, B (beta), O (occupancy)
	
	consref				dna_gbis_eq.constraints.pdb;		# PDB File with reference (equilibrium) position of constrained atoms
	
	constraintScaling	1.0;		# Harmonic constraint energy func is muliplied by this factor at every timestpe. Allows to gradually turn off constraints
	
	## Selected Constraints: Restrain only selected Cartesian components of the coordinates 
	# Useful for allowing motion along a place or axis
	# EX. 1. Restraint X only: Allow motion only in YZ Plane
	#     2. Restraint Y and z: Allow motion only in X axis
	if {1} {
		selectConstraints		on;			# on | off selected constraints	
		
		selectConstrX			off;		# Restrain about X components of coordinates
		selectConstrY			on;			# Restrain about Y components of coordinates
		selectConstrZ			on;			# Restrain about Z components of coordinates
	}
}

#############################################################
## EXECUTION SCRIPT                                        ##
#############################################################

# Minimization (atomic velocities are set to 0 before minimization)
# TODO: Disable if already minimized, like doing SMD on already equilibraited system
if {$run_index == 0} {
	if {0} {
		minimize            1000;		# TODO: time steps to run minimization of energy
		reinitvels          $temperature;	# after minimization, re-initialize atomic velocities according to this temperature
	}
}

# Equilibriation
run 30000000;		# TODO: time steps to equilibriate the system
